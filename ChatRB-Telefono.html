<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatRB Móvil</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#0f172a; color:white; display:flex; flex-direction:column; align-items:center; }
h1 { color:#38bdf8; text-align:center; margin-top:10px; }
#chatContainer { display:flex; flex-direction:column; width:95%; max-width:500px; margin-top:10px; }
#chat { background:#1e293b; height:300px; border-radius:10px; padding:10px; overflow-y:auto; box-shadow:0 0 10px #0ea5e9; margin-bottom:10px; }
#users { background:#1e293b; border-radius:10px; padding:10px; margin-bottom:10px; max-height:200px; overflow-y:auto; }
input, button { padding:10px; border:none; border-radius:8px; margin-bottom:5px; }
#messageInput, #groupCodeInput, #usernameInput { width:70%; background:#334155; color:white; }
button { background:#38bdf8; color:#0f172a; font-weight:bold; cursor:pointer; }
button:hover { background:#0ea5e9; }
#logoutBtn { background:red; color:white; margin-bottom:10px; }
#namePopup { display:flex; justify-content:center; align-items:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; }
#namePopupContent { background:#1e293b; padding:20px; border-radius:10px; text-align:center; }
#namePopupContent input { width:80%; padding:10px; border-radius:8px; border:none; background:#334155; color:white; margin-bottom:10px; }
#namePopupContent button { padding:10px 15px; border:none; border-radius:8px; background:#38bdf8; color:#0f172a; font-weight:bold; cursor:pointer; }
#namePopupContent button:hover { background:#0ea5e9; }
#currentGroup { color:#facc15; margin-bottom:10px; text-align:center; }
.userItem { margin-bottom:5px; }
.userInGroup { color:#facc15; font-weight:bold; }
</style>
</head>
<body>

<h1>💬 ChatRB Móvil</h1>

<div id="chatContainer">
  <div id="currentGroup">No estás en ningún grupo</div>
  <div id="chat"></div>
  <input type="text" id="messageInput" placeholder="Escribe un mensaje..." disabled>
  <button id="sendBtn" disabled>Enviar</button>
  <input type="text" id="groupCodeInput" placeholder="Código del grupo">
  <button id="createGroupBtn">Crear grupo</button>
  <button id="joinGroupBtn">Unirse al grupo</button>
  <button id="logoutBtn">Cerrar sesión</button>
  <div id="users">
    <h3>Usuarios en línea</h3>
    <ul id="userList"></ul>
  </div>
</div>

<div id="namePopup">
  <div id="namePopupContent">
    <h2>Elige tu nombre</h2>
    <input type="text" id="usernameInput" placeholder="Tu nombre...">
    <br>
    <button id="setNameBtn">Aceptar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, query, orderBy, onSnapshot, getDoc, updateDoc, arrayUnion, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB8laLYCXZvLj_f5iI0DSBBxy4rCmcWF38",
  authDomain: "chatrb-850cb.firebaseapp.com",
  projectId: "chatrb-850cb",
  storageBucket: "chatrb-850cb.firebasestorage.app",
  messagingSenderId: "952386742311",
  appId: "1:952386742311:web:a0a6cf328be2ee6147c602"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let username = "";
let currentGroup = "";

// Función para mostrar popup
function mostrarPopup(){ document.getElementById("namePopup").style.display="flex"; }

// Verificar si hay usuario guardado
if(localStorage.getItem("username")){
    username = localStorage.getItem("username");
    document.getElementById("namePopup").style.display="none";
    registrarUsuario();
    actualizarUsuariosGlobal();
} else {
    mostrarPopup();
}

// Elegir nombre
function setNombre(){
  const input = document.getElementById("usernameInput").value.trim();
  if(input){
    username = input;
    localStorage.setItem("username", username);
    document.getElementById("namePopup").style.display="none";
    registrarUsuario();
    actualizarUsuariosGlobal();
  }
}
document.getElementById("setNameBtn").addEventListener("click", setNombre);

// Cerrar sesión
document.getElementById("logoutBtn").addEventListener("click", ()=>{
    localStorage.removeItem("username");
    location.reload();
});

// Registrar usuario
async function registrarUsuario(){
  const userRef = doc(db,"usuarios",username);
  await setDoc(userRef,{online:true});
}

// Crear grupo
async function crearGrupo(){
  const code = document.getElementById("groupCodeInput").value.trim();
  if(!code) return alert("Escribe un código para el grupo");
  const grupoRef = doc(db,"grupos",code);
  await setDoc(grupoRef,{admin:username, miembros:[username]});
  currentGroup = code;
  habilitarChat(true);
  document.getElementById("currentGroup").textContent = `Grupo: ${currentGroup}`;
  escucharMensajes();
  actualizarUsuariosGlobal();
}

// Unirse a grupo
async function unirseGrupo(){
  const code = document.getElementById("groupCodeInput").value.trim();
  if(!code) return alert("Escribe el código del grupo");
  const grupoRef = doc(db,"grupos",code);
  const grupoSnap = await getDoc(grupoRef);
  if(!grupoSnap.exists()){ alert("Grupo no existe"); return; }
  await updateDoc(grupoRef,{miembros:arrayUnion(username)});
  currentGroup = code;
  habilitarChat(true);
  document.getElementById("currentGroup").textContent = `Grupo: ${currentGroup}`;
  escucharMensajes();
  actualizarUsuariosGlobal();
}

// Enviar mensaje
async function enviarMensaje(){
  const input = document.getElementById("messageInput");
  const texto = input.value.trim();
  if(!texto || !username || !currentGroup) return;
  await addDoc(collection(db,"mensajes"),{
    texto:texto,
    username:username,
    grupo:currentGroup,
    fecha:new Date()
  });
  input.value="";
}

// Escuchar mensajes
function escucharMensajes(){
  if(!currentGroup) return;
  const q = query(collection(db,"mensajes"), orderBy("fecha"));
  onSnapshot(q,(snapshot)=>{
    const chat = document.getElementById("chat");
    chat.innerHTML="";
    snapshot.forEach(doc=>{
      const data = doc.data();
      if(data.grupo===currentGroup){
        const fecha = new Date(data.fecha.seconds*1000);
        const hora = fecha.getHours().toString().padStart(2,"0");
        const min = fecha.getMinutes().toString().padStart(2,"0");
        chat.innerHTML += `<p>${hora}:${min} <strong>${data.username}:</strong> ${data.texto}</p>`;
      }
    });
    chat.scrollTop = chat.scrollHeight;
  });
}

// Mostrar todos los usuarios en línea
async function actualizarUsuariosGlobal(){
  const ul = document.getElementById("userList");
  ul.innerHTML = "";
  const usuariosSnap = await getDocs(collection(db,"usuarios"));
  let miembrosGrupo = [];
  if(currentGroup){
    const grupoSnap = await getDoc(doc(db,"grupos",currentGroup));
    miembrosGrupo = grupoSnap.exists() ? grupoSnap.data().miembros : [];
  }
  usuariosSnap.forEach(u=>{
    const data = u.data();
    const li = document.createElement("li");
    li.textContent = `${u.id} - ${data.online ? "En línea" : "Offline"}`;
    if(miembrosGrupo.includes(u.id)) li.classList.add("userInGroup");
    li.classList.add("userItem");
    ul.appendChild(li);
  });
}

// Habilitar o deshabilitar chat
function habilitarChat(valor){
  document.getElementById("messageInput").disabled = !valor;
  document.getElementById("sendBtn").disabled = !valor;
}

// Eventos
document.getElementById("sendBtn").addEventListener("click", enviarMensaje);
document.getElementById("messageInput").addEventListener("keypress",(e)=>{ if(e.key==="Enter") enviarMensaje(); });
document.getElementById("createGroupBtn").addEventListener("click", crearGrupo);
document.getElementById("joinGroupBtn").addEventListener("click", unirseGrupo);

// Actualizar usuarios cada 10s
setInterval(actualizarUsuariosGlobal,10000);
</script>
</body>
</html>
